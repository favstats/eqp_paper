---
title: "Trolley Experiment"
author: "Fabio Votta"
date: "The Date"
output: github_document
---

```{r, echo=F}
knitr::opts_chunk$set(message = F, warning = F, fig.align = "center", fig.width = 10, fig.height = 6)
```


## packages

```{r}
pacman::p_load(tidyverse, haven, psych, sjPlot, ggpubr)
```

## data

```{r}
trolley <- read_spss("data/TrolleyExperimentArgumentNew.sav") %>% 
  janitor::clean_names(.) %>% 
  filter(general_finisher == 1) %>% 
  drop_na(t1_eqp_eqp1, t1_eqp_eqp3, t1_eqp_eqp7, t1_eqp_eqp8, t1_eqp_eqp9,
         t1_eqp_eqp11, t1_eqp_eqp12 ,t1_eqp_eqp13, t1_eqp_eqp14, t1_eqp_eqp18,
         t1_eqp_eqp2, t1_eqp_eqp4, t1_eqp_eqp5, t1_eqp_eqp6, t1_eqp_eqp10,
         t1_eqp_eqp15, t1_eqp_eqp16 ,t1_eqp_eqp17, t1_eqp_eqp19, t1_eqp_eqp20,
         t1_szenario1q2, t2_szenario1q2, t1_szenario2q2, t2_szenario2q2) %>% 
  filter(t2_gender != 2) %>% 
  mutate(gender = ifelse(t2_gender == 1, "Men", "Women")) %>% 
  mutate(leftright = t2_pol_alignment) %>% 
  mutate(pol_interest = 5 - t2_pol_interest) %>% 
  mutate(church_attendance = 7 - t2_religion_church) %>% 
  mutate(age = 2018 - as.numeric(t2_year_of_birth)) %>% 
  mutate(university = ifelse(t2_university == 4, 0, 1)) %>% 
  mutate(groups = case_when(
    general_group_control == 1 ~ "Control Group",
    general_group_discussion == 1 ~ "Discussion Group",
    general_group_information == 1 ~ "Information Group",
  )) 

trolley
```


## Basic Stats

```{r, analysis}
trolley %>% 
  group_by(university) %>% 
  tally() %>% knitr::kable()

trolley %>% 
  group_by(gender) %>% 
  tally() %>% knitr::kable()

trolley %>% 
  group_by(groups) %>% 
  tally() %>% knitr::kable()

trolley %>% 
  select(leftright, pol_interest, church_attendance, age) %>% 
  describe() %>% knitr::kable()
```

## Factor Analysis

```{r}
eqp <- trolley %>% 
  select(contains("eqp")) %>% 
#  na.omit() %>% 
  select(t1_eqp_eqp1, t1_eqp_eqp3, t1_eqp_eqp7, t1_eqp_eqp8, t1_eqp_eqp9,
         t1_eqp_eqp11, t1_eqp_eqp12 ,t1_eqp_eqp13, t1_eqp_eqp14, t1_eqp_eqp18,
         t1_eqp_eqp2, t1_eqp_eqp4, t1_eqp_eqp5, t1_eqp_eqp6, t1_eqp_eqp10,
         t1_eqp_eqp15, t1_eqp_eqp16 ,t1_eqp_eqp17, t1_eqp_eqp19, t1_eqp_eqp20)


trolley <- eqp %>% 
  psych::pca(2, rotate = "varimax") %>% 
  predict.psych(data = eqp) %>% 
  cbind(trolley, .)
  
trolley <- trolley %>% 
  rename(idealism_pca = RC1) %>% 
  rename(relativism_pca = RC2)   
```

## Randomisierung/Descriptives

### Age

```{r}
my_comparisons <- list( c("Control Group", "Discussion Group"), 
                        c("Discussion Group", "Information Group"), 
                        c("Control Group", "Information Group") )

age_compare <- trolley %>% 
  ggplot(aes(groups, age)) +
  geom_violin(aes(fill = groups), alpha = 0.6) +
  geom_boxplot(width = 0.2) +
  xlab("Experimental Groups") + ylab("Age") +
  ggtitle("Age Comparison between Experimental Groups") +
  ggpubr::stat_compare_means(comparisons = my_comparisons) +
  ggthemes::scale_fill_gdocs("") +
  ggthemes::theme_hc() +
  guides(fill = F)

age_compare

tidytemplate::ggsave_it(age_compare, width = 10, height = 6)
```
### Gender


```{r}
gender_compare <- sjp.xtab(trolley$groups, trolley$gender, 
         margin = "row", bar.pos = "stack",
         show.summary = TRUE, coord.flip = TRUE, 
         prnt.plot = F)$plot +
  ggthemes::theme_hc() +
  ggthemes::scale_fill_gdocs("Gender") +
  xlab("") +
  ggtitle("Gender Comparison between Experimental Groups") +
  scale_alpha(range = c(0.4, 0.8))

gender_compare

tidytemplate::ggsave_it(gender_compare, width = 10, height = 6)
```


#### Together

```{r, fig.width=14, fig.height=6}
dem_compare <- cowplot::plot_grid(age_compare, gender_compare)

dem_compare

tidytemplate::ggsave_it(dem_compare, width = 14, height = 6)
```


### Idealism

```{r}
my_comparisons <- list( c("Control Group", "Discussion Group"), 
                        c("Discussion Group", "Information Group"), 
                        c("Control Group", "Information Group") )

idealism_pca_compare <- trolley %>% 
  ggplot(aes(groups, idealism_pca)) +
  geom_violin(aes(fill = groups), alpha = 0.6) +
  geom_boxplot(width = 0.2) +
  xlab("Experimental Groups") + ylab("Idealism") +
  ggtitle("Idealism Comparison between Experimental Groups") +
  ggpubr::stat_compare_means(comparisons = my_comparisons) +
  ggthemes::scale_fill_gdocs("") +
  ggthemes::theme_hc() +
  guides(fill = F)

idealism_pca_compare

tidytemplate::ggsave_it(idealism_pca_compare, width = 10, height = 6)
```

### Relativism

```{r}
my_comparisons <- list( c("Control Group", "Discussion Group"), 
                        c("Discussion Group", "Information Group"), 
                        c("Control Group", "Information Group") )

relativism_pca_compare <- trolley %>% 
  ggplot(aes(groups, relativism_pca)) +
  geom_violin(aes(fill = groups), alpha = 0.6) +
  geom_boxplot(width = 0.2) +
  xlab("Experimental Groups") + ylab("Relativism") +
  ggtitle("Relativism Comparison between Experimental Groups") +
  ggpubr::stat_compare_means(comparisons = my_comparisons) +
  ggthemes::scale_fill_gdocs("") +
  ggthemes::theme_hc() +
  guides(fill = F)

relativism_pca_compare

tidytemplate::ggsave_it(relativism_pca_compare, width = 10, height = 6)
```

#### Together

```{r, fig.width=12, fig.height=6}
uv_compare <- cowplot::plot_grid(relativism_pca_compare, idealism_pca_compare)

uv_compare

tidytemplate::ggsave_it(uv_compare, width = 12, height = 6)
```

### AVs

#### Switch Track

```{r}
my_comparisons <- list( c("Control Group", "Discussion Group"), 
                        c("Discussion Group", "Information Group"), 
                        c("Control Group", "Information Group") )

t1_szenario1q2_compare <- trolley %>% 
  ggplot(aes(groups, t1_szenario1q2)) +
  geom_violin(aes(fill = groups), alpha = 0.6) +
  geom_boxplot(width = 0.2) +
  xlab("Experimental Groups") + ylab("Morally justifiable: Switch Track") +
  ggtitle("'Switch Track' Comparison between Experimental Groups") +
  ggpubr::stat_compare_means(comparisons = my_comparisons) +
  ggthemes::scale_fill_gdocs("") +
  ggthemes::theme_hc() +
  guides(fill = F)

t1_szenario1q2_compare

tidytemplate::ggsave_it(t1_szenario1q2_compare, width = 10, height = 6)
```

#### Push Person


```{r}
my_comparisons <- list( c("Control Group", "Discussion Group"), 
                        c("Discussion Group", "Information Group"), 
                        c("Control Group", "Information Group") )

t1_szenario2q2_compare <- trolley %>% 
  ggplot(aes(groups, t1_szenario2q2)) +
  geom_violin(aes(fill = groups), alpha = 0.6) +
  geom_boxplot(width = 0.2) +
  xlab("Experimental Groups") + ylab("Morally justifiable: Push Person") +
  ggtitle("'Push Person' Comparison between Experimental Groups") +
  ggpubr::stat_compare_means(comparisons = my_comparisons) +
  ggthemes::scale_fill_gdocs("") +
  ggthemes::theme_hc() +
  guides(fill = F)

t1_szenario2q2_compare

tidytemplate::ggsave_it(t1_szenario2q2_compare, width = 10, height = 6)
```

##### Together

```{r, fig.width=12, fig.height=6}
av_compare <- cowplot::plot_grid(t1_szenario1q2_compare, t1_szenario2q2_compare)

av_compare

tidytemplate::ggsave_it(av_compare, width = 12, height = 6)
```

### Demographics

```{r}

t1_szenario1q2_gender <- trolley %>% 
  ggplot(aes(gender, t1_szenario1q2)) +
  geom_violin(aes(fill = gender), alpha = 0.6) +
  geom_boxplot(width = 0.2) +
  xlab("Gender") + ylab("Morally justifiable: Switch Track") +
  ggtitle("Morally Justifiable to Switch Track by Gender") +
  ggpubr::stat_compare_means(label.x.npc = .4) +
  ggthemes::scale_fill_gdocs("") +
  ggthemes::theme_hc() +
  guides(fill = F)

t1_szenario1q2_gender

tidytemplate::ggsave_it(t1_szenario1q2_gender, width = 10, height = 6)

t1_szenario2q2_gender <- trolley %>% 
  ggplot(aes(gender, t1_szenario2q2)) +
  geom_violin(aes(fill = gender), alpha = 0.6) +
  geom_boxplot(width = 0.2) +
  xlab("Gender") + ylab("Morally justifiable: Push Person") +
  ggtitle("Morally Justifiable to Push Person by Gender") +
  ggpubr::stat_compare_means(label.x.npc = .5) +
  ggthemes::scale_fill_gdocs("") +
  ggthemes::theme_hc() +
  guides(fill = F)

t1_szenario2q2_gender

tidytemplate::ggsave_it(t1_szenario2q2_gender, width = 10, height = 6)

gender_av_compare <- cowplot::plot_grid(t1_szenario1q2_gender, t1_szenario2q2_gender)

gender_av_compare

tidytemplate::ggsave_it(gender_av_compare, width = 12, height = 6)
```

#### Scatters

```{r}
t1_szenario1q2_gender <- trolley %>% 
  ggplot(aes(age, t1_szenario1q2)) +
  geom_jitter(aes(color = gender), alpha = 0.6) +
  geom_smooth(aes(color = gender),method = "lm") +
  xlab("Age") + ylab("Morally justifiable: Switch Track") +
  ggtitle("Morally Justifiable to Switch Track by Gender and Age") +
  ggpubr::stat_compare_means(label.x.npc = .4) +
  ggthemes::scale_color_gdocs("") +
  ggthemes::theme_hc() +
  guides(fill = F)

t1_szenario1q2_gender

tidytemplate::ggsave_it(t1_szenario1q2_gender, width = 10, height = 6)

t1_szenario2q2_gender <- trolley %>% 
  ggplot(aes(age, t1_szenario2q2)) +
  geom_jitter(aes(color = gender), alpha = 0.6) +
  geom_smooth(aes(color = gender),method = "lm") +
  xlab("Age") + ylab("Morally justifiable: Push Person") +
  ggtitle("Morally Justifiable to Push Person by Gender and Age") +
  ggpubr::stat_compare_means(label.x.npc = .5) +
  ggthemes::scale_color_gdocs("") +
  ggthemes::theme_hc() +
  guides(fill = F)

t1_szenario2q2_gender

tidytemplate::ggsave_it(t1_szenario2q2_gender, width = 10, height = 6)

gender_av_compare <- cowplot::plot_grid(t1_szenario1q2_gender, t1_szenario2q2_gender)

gender_av_compare

tidytemplate::ggsave_it(gender_av_compare, width = 12, height = 6)
```

## Factor Analysis Table

```{r}
# eqp %>% 
#   psych::pca(2, rotate = "varimax") %>% 
#   .$loadings %>% unclass() %>% as.data.frame() %>% 
#   rownames_to_column("eqp_variable")

strip_away_stuff <- function(x) {
x <- str_remove(x, "t1_eqp_")
x <- parse_number(x) %>% 
  ifelse(. %in% 1:9, paste0("eqp0", .), .) %>% 
  ifelse(. %in% 10:20, paste0("eqp", .), .) 
}

eqp <- eqp %>% 
  set_names(eqp %>% names %>% strip_away_stuff) 

factor_names <- c(`1` = "Idealism",
                  `2` = "Relativism")


factor_analysis <- sjp.pca(eqp, rotation = "varimax", 
        nmbr.fctr = 2, prnt.plot = F, show.cronb = T, 
        show.values = T)$plot  +
  ggthemes::scale_color_gdocs("") +
  ggthemes::theme_hc() +
  ggtitle("Ethical Positions Questionnaire - Factor Analysis") +
  facet_grid(~xpos, labeller = as_labeller(factor_names))

factor_analysis

tidytemplate::ggsave_it(factor_analysis, width = 10, height = 6)
```

## Summary Statistics

```{r}
trolley %>% 
  select(t1_szenario1q2, t2_szenario1q2, t1_szenario2q2, t2_szenario2q2, idealism_pca, relativism_pca, gender, age, church_attendance, general_group_control, general_group_discussion, general_group_information) %>% 
  describe() %>% 
  select(-vars, -trimmed, -mad, -se) %>% 
  knitr::kable()
```


## Models

### Szenario 1

1. t1 als AV
2. t2 mit Controls für t1 und für treatments 
3. Modelle aus 2. mit Treatment-Interaktion (Idealism)
4. Modelle aus 2. mit Treatment-Interaktion (Relativism)

```{r}
trolley %<>% 
  mutate(groups = factor(groups)) %>% 
  mutate(gender = factor(gender))

fit1_s1 <- lm(t1_szenario1q2 ~ idealism_pca + relativism_pca + 
             gender + age + church_attendance +
             groups, 
           data = trolley)

sjPlot::plot_model(fit1_s1, show.p = T, show.values = T) +
  ggtitle("Model1a - Opinion Change in Szenario 1") +
  ggthemes::theme_hc() +
  ggthemes::scale_fill_fivethirtyeight()

ggsave(filename = "images/reg1_s1.png", width = 5, height = 5)

fit2_s1 <- lm(t2_szenario1q2 ~ t1_szenario1q2 + idealism_pca + relativism_pca + 
             gender + age + church_attendance +
             groups, 
           data = trolley)

sjPlot::plot_model(fit2_s1, show.p = T, show.values = T) +
  ggtitle("Model2a - Opinion Change in Szenario 1") +
  ggthemes::theme_hc() +
  ggthemes::scale_fill_fivethirtyeight()

ggsave(filename = "images/reg2_s1.png", width = 5, height = 5)

fit3_s1 <- lm(t2_szenario1q2 ~ t1_szenario1q2 + idealism_pca + relativism_pca + 
             gender + age + church_attendance +
             groups * idealism_pca, 
           data = trolley)

sjPlot::plot_model(fit3_s1, show.p = T, show.values = T) +
  ggtitle("Model3a - Opinion Change in Szenario 1") +
  ggthemes::theme_hc() +
  ggthemes::scale_fill_fivethirtyeight()

ggsave(filename = "images/reg3_s1.png", width = 5, height = 5)

# sjPlot::sjp.int(fit3_s1, p.kr = F)$plot +
#   ggtitle("Model3a - Interaction") +
#   ggthemes::theme_hc() +
#   ggthemes::scale_fill_fivethirtyeight()

ggsave(filename = "images/reg3_s1.png", width = 5, height = 5)

fit4_s1 <- lm(t2_szenario1q2 ~ t1_szenario1q2 + idealism_pca + relativism_pca + 
             gender + age + church_attendance +
             groups * relativism_pca, 
           data = trolley)

sjPlot::plot_model(fit4_s1, show.p = T, show.values = T) +
  ggtitle("Model4a - Opinion Change in Szenario 1") +
  ggthemes::theme_hc() +
  ggthemes::scale_fill_fivethirtyeight()

ggsave(filename = "images/reg4_s1.png", width = 5, height = 5)


```

### Szenario 2

1. t1 als AV
2. t2 mit Controls für t1 und für treatments 
3. Modelle aus 2. mit Treatment-Interaktion (Idealism)
4. Modelle aus 2. mit Treatment-Interaktion (Relativism)

```{r}

fit1_s2 <- lm(t1_szenario2q2 ~ idealism_pca + relativism_pca + 
             gender + age + church_attendance +
             groups, 
           data = trolley)

sjPlot::plot_model(fit1_s2, show.p = T, show.values = T) +
  ggtitle("Model1b - Opinion Change in Szenario 2") +
  ggthemes::theme_hc() +
  ggthemes::scale_fill_fivethirtyeight()

ggsave(filename = "images/reg1_s2.png", width = 5, height = 5)

fit2_s2 <- lm(t2_szenario2q2 ~ t1_szenario2q2 + idealism_pca + relativism_pca + 
             gender + age + church_attendance +
             groups, 
           data = trolley)

sjPlot::plot_model(fit2_s2, show.p = T, show.values = T) +
  ggtitle("Model2b - Opinion Change in Szenario 2") +
  ggthemes::theme_hc() +
  ggthemes::scale_fill_fivethirtyeight()

ggsave(filename = "images/reg2_s2.png", width = 5, height = 5)

fit3_s2 <- lm(t2_szenario2q2 ~ t1_szenario2q2 + idealism_pca + relativism_pca + 
             gender + age + church_attendance +
             groups * idealism_pca, 
           data = trolley)

sjPlot::plot_model(fit3_s2, show.p = T, show.values = T) +
  ggtitle("Model3b - Opinion Change in Szenario 2") +
  ggthemes::theme_hc() +
  ggthemes::scale_fill_fivethirtyeight()

ggsave(filename = "images/reg3_s2.png", width = 5, height = 5)


fit4_s2 <- lm(t2_szenario2q2 ~ t1_szenario2q2 + idealism_pca + relativism_pca + 
             gender + age + church_attendance +
             groups * relativism_pca, 
           data = trolley)

sjPlot::plot_model(fit4_s2, show.p = T, show.values = T) +
  ggtitle("Model4b - Opinion Change in Szenario 2") +
  ggthemes::theme_hc() +
  ggthemes::scale_fill_fivethirtyeight()

ggsave(filename = "images/reg4_s2.png", width = 5, height = 5)


```